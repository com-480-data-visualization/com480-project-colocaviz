<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventaire</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>

<body class="inventory-page">

    <header>
        <nav class="top-nav">
            <a href="index.html">üè† Home</a>
            <a href="viz.html">üåç Interactive Visualizations</a>
            <a href="inventory.html" class="active">üìù Inventory</a>
            <a href="comparateur.html">üìä Comparison</a>
            <a href="basket.html">üõí Basket</a>
        </nav>
    </header>

    <div class="main-content">
        <h1>üìù Dataset Inventory</h1>
        <section class="search-panel">
            <div class="form-row">
                <label for="layerSelect">üîé Level :
                    <select id="layerSelect">
                        <option value="2">Main Categories</option>
                        <option value="3">Sub-Categories</option>
                        <option value="4">Products (Production data available)</option>
                    </select>
            </div>

            <div class="search-container">
                <input type="text" id="searchBox" placeholder="Search for a product..." autocomplete="off" 
                    onfocus="this.value=''" />
                <ul id="dropdownList" class="dropdown" style="display: none;"></ul>
            </div>
        </section>

        <section class="results-panel">

            <div class="results" id="results"></div>
        </section>
    </div>

    <script type="module">
        import { RacingBarChart, initChart } from './assets/js/barchart_race.js';

        function getEmoji(name) {
            const emojiMap = {
                oil: "üõ¢Ô∏è",
                pesto: "üçÉ",
                plant: "üå±",
                eggplant: "üçÜ",
                pumpkin: "üéÉ",
                pasta: "üçù",
                cookie: "üç™",
                chocolate: "üç´",
                spinach: "ü•¨",
                zucchini: "ü•í",
                beef: "ü•©",
                lamb: "ü•©",
                pork: "ü•©",
                date: "üå¥",
                raisin: "üçá",
                apricot: "üçë",
                berry: "ü´ê",
                currant: "ü´ê",
                bacon: "ü•ì",
                kiwi: "ü•ù",
                chicken: "üçó",
                poultry: "üçó",
                egg: "ü•ö",
                milk: "ü•õ",
                cream: "üç∂",
                "dairy products": "üç∂",
                mascarpone: "üç∂",
                mozzarella: "üßÄ",
                "parmigiano reggiano": "üßÄ",
                seed: "üå±",
                sunflower: "üåª",
                chilly: "üå∂Ô∏è",
                ricotta: "üßÄ",
                stracchino: "üßÄ",
                mealworm: "ü™±",
                tangerin: "üçä",
                mandarin: "üçä",
                olive: "ü´í",
                pineapple: "üçç",
                barley: "üåæ",
                flour: "üåæ",
                grains: "üåæ",
                millet: "üåæ",
                oat: "üåæ",
                rye: "üåæ",
                sorghum: "üåæ",
                wheat: "üåæ",
                beans: "ü´ò",
                chickpea: "ü´ò",
                cowpea: "ü´ò",
                lentil: "ü´ò",
                soybean: "ü´ò",
                chestnut: "üå∞",
                hazelnut: "üå∞",
                "mixed nut": "üå∞",
                "palm nut": "üå∞",
                pistachio: "üå∞",
                burger: "üçî",
                peanut: "ü•ú",
                maize: "üåΩ",
                clementine: "üçä",
                cheese: "üßÄ",
                yogurt: "üç∂",
                butter: "üßà",
                margarine: "üßà",
                fish: "üêü",
                salmon: "üêü",
                trout: "üêü",
                turbot: "üêü",
                carp: "üêü",
                cod: "üêü",
                apple: "üçé",
                banana: "üçå",
                orange: "üçä",
                lemon: "üçã",
                lime: "üçã",
                mango: "ü•≠",
                pear: "üçê",
                peach: "üçë",
                plum: "üçë",
                pineapple: "üçç",
                grape: "üçá",
                strawberry: "üçì",
                raspberry: "üçì",
                blueberry: "ü´ê",
                raspberry: "ü´ê",
                avocado: "ü•ë",
                tomato: "üçÖ",
                ketchup: "üçÖ",
                cucumber: "ü•í",
                carrot: "ü•ï",
                corn: "üåΩ",
                "sweet potato": "üç†",
                cabbage: "ü•¨",
                cauliflower: "ü•¶",
                potato: "ü•î",
                onion: "üßÖ",
                garlic: "üßÑ",
                broccoli: "ü•¶",
                lettuce: "ü•¨",
                bread: "üçû",
                cake: "üç∞",
                croissant: "ü•ê",
                wine: "üç∑",
                beer: "üç∫",
                juice: "üßÉ",
                coffee: "‚òï",
                sugar: "üç¨",
                pepper: "üå∂Ô∏è",
                ginger: "ü´ö",
                watermelon: "üçâ",
                fruit: "üçé",
                legumes: "üå±",
                nuts: "üå∞",
                spicies: "üå∂Ô∏è",
                tubers: "ü•î",
                vegetables: "ü•¶",
                biscuits: "üç™",
                drinks: "üçπ",
                vegetal: "üå±",
                animal: "üêÆ",
                "processed food": "üçï",
                crops: "üåæ"
            };

            const key = Object.keys(emojiMap).find(k => name.toLowerCase().includes(k));
            return emojiMap[key] || "üçΩÔ∏è";
        }

        function getBarchartTitle(name, metric, n=8) {
            const titles = {
                "production_t": {
                    "title": `Production of ${name} in tons per year`,
                    "subtitle": `Barchart race showcasing the top ${n} countries producing ${name}`
                },
                "area_harvested_ha": {
                    "title": `Harvested Area for ${name} per year (in ha)`,
                    "subtitle": `Barchart race showcasing the top ${n} countries with the highest harvest area for ${name}`
                },
                "producing_animals_slaughtered_an": {
                    "title": `Animals slaughtered per year for the production of ${name}`,
                    "subtitle": `Barchart race showcasing the top ${n} countries with the highest number of animals slaughtered`
                }
            };
            return titles[metric];
        }


        function flattenByLevel(node, level, currentLevel = 1, result = []) {
            if (currentLevel === level) {
                result.push({ name: node.name, value: node.value });
            } else if (node.children) {
                node.children.forEach(child => flattenByLevel(child, level, currentLevel + 1, result));
            }
            return result;
        }

        let carbonRoot = null;
        let waterRoot = null;
        let productionRoot = null;
        let productionItems = null;
        let charts = [];
        let currentList = [];

        Promise.all([
            d3.json("data/data_carbon.json"),
            d3.json("data/data_water.json"),
            // TODO replace with real data
            d3.json("data/data_production.json")
        ]).then(([carbon, water, production]) => {
            carbonRoot = carbon;
            waterRoot = water;
            productionRoot = production;
            productionItems = new Set(Object.keys(production))
            updateList();
        });

        document.getElementById("layerSelect").addEventListener("change", updateList);
        document.getElementById("searchBox").addEventListener("input", filterDropdown);
        document.getElementById("searchBox").addEventListener("focus", () => {
            if (currentList.length > 0) {
                filterDropdown();
            }
        });
        document.addEventListener("click", (e) => {
            const container = document.querySelector(".search-container");
            if (!container.contains(e.target)) {
                document.getElementById("dropdownList").style.display = "none";
            }
        });

        function updateList() {
            const level = +document.getElementById("layerSelect").value;
            currentList = flattenByLevel(carbonRoot, level);
            filterDropdown();
            document.getElementById("dropdownList").style.display = "none";
        }

        function filterDropdown() {
            const query = document.getElementById("searchBox").value.toLowerCase();
            const filtered = currentList.filter(d => d.name.toLowerCase().includes(query));
            const dropdown = document.getElementById("dropdownList");

            dropdown.innerHTML = "";

            if (filtered.length === 0) {
                dropdown.style.display = "none";
                return;
            }

            filtered.forEach(d => {
                const li = document.createElement("li");
                // TODO Add red text to show if production data is missing
                li.textContent = d.name.charAt(0).toUpperCase() + d.name.slice(1);
                if (productionItems.has(d.name)) {
                    const greenText = document.createElement("span");
                    greenText.textContent = "‚úî Production data available";
                    greenText.style.color = "green";
                    greenText.style.marginLeft = "10px";
                    li.appendChild(greenText);
                }
                li.addEventListener("click", () => {
                    document.getElementById("searchBox").value = d.name.charAt(0).toUpperCase() + d.name.slice(1);
                    dropdown.style.display = "none";
                    showDetails(d.name);
                });
                dropdown.appendChild(li);
            });

            dropdown.style.display = "block";
        }

        function showDetails(name) {
            if (charts.length) {
                charts.forEach(chart => {
                    if (chart.animationRunning) {
                        chart.pause();
                    }
                });
            }
            const carbonMatch = findByName(carbonRoot, name);
            const waterMatch = findByName(waterRoot, name);
            const productionMatch = productionItems.has(name);

            const maxCarbon = getMaxValue(carbonRoot);
            const maxWater = getMaxValue(waterRoot);

            const resultDiv = document.getElementById("results");
            let html = `<div class="result-name">${getEmoji(name)} ${name}</div><div style="margin-bottom: 1rem;"></div>`;

            html += `<h2 style="margin: 10px;">üå± Environmental Footprint per 1kg (1L)</h2>`;
            if (carbonMatch) {
                const carbonPct = Math.round((carbonMatch.value / maxCarbon) * 100);
                html += `<div class="result-item">
                        <span class="highlight">üåç Carbon:</span> ${carbonMatch.value} kg CO‚ÇÇ
                        <div class="impact-bar">
                            <div class="bar carbon-bar" style="width: ${carbonPct}%"></div>
                        </div>
                    </div>`;
            }

            if (waterMatch) {
                const waterPct = Math.round((waterMatch.value / maxWater) * 100);
                html += `
                    <div class="result-item">
                        <span class="highlight">üíß Water:</span> ${waterMatch.value} L
                        <div class="impact-bar">
                            <div class="bar water-bar" style="width: ${waterPct}%"></div>
                        </div>
                    </div>`;
            }

            resultDiv.innerHTML = html;

            if (productionMatch) {
                resultDiv.innerHTML += `<h2 style="margin: 20px;">üìà Production Data</h2`
                const metrics = new Set(Object.keys(productionRoot[name]));
                for (const metric of metrics) {
                    const defaultOptions = {
                        margin: { top: 16, right: 6, bottom: 6, left: 0 },
                        barSize: 48,
                        n: 8,
                        k: 5,
                        duration: 100,
                        width: 928
                    };

                    const chart = new RacingBarChart("results", `chart-${metric}`, {...defaultOptions});
                    charts.push(chart);
                    const title = getBarchartTitle(name, metric);
                    chart.init(productionRoot, title, name, metric);
                }
            } else {
                resultDiv.innerHTML += `
                    <h2 style="margin: 20px;">üìà Production Data</h2>
                    <div class="result-item">
                        <span class="highlight" style="color: red;">‚ùó No production data available for ${name}.</span>
                    </div>`;

            }

            // Add a separator for production visualizations

        }

        function getMaxValue(node) {
            let max = node.value || 0;
            if (node.children) {
                node.children.forEach(child => {
                    max = Math.max(max, getMaxValue(child));
                });
            }
            return max;
        }

        function findByName(node, name) {
            if (node.name === name) return node;
            if (node.children) {
                for (const child of node.children) {
                    const found = findByName(child, name);
                    if (found) return found;
                }
            }
            return null;
        }
    </script>
    <script src="assets/js/barchart_race.js" defer></script>
</body>

</html>


<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing Bar Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
        --sans-serif: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .controls button {
            margin: 0 5px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        
        .controls button:hover {
            background-color: #0056b3;
        }
        
        .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #chart {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 0 auto;
            max-width: 960px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="start-btn">Start</button>
        <button id="pause-btn" disabled>Pause</button>
        <button id="reset-btn">Reset</button>
    </div>
    
    <div id="chart"></div>

    <script src="assets/js/barchart_race.js" defer></script>
</body>
</html> -->